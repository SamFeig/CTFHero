// Copyright 2018 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.



var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();$jscomp.initSymbol();$jscomp.initSymbolIterator();var b=a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(a){function b(){this.batch_=null}function c(a){return a instanceof e?a:new e(function(b,c){b(a)})}if(a&&!$jscomp.FORCE_POLYFILL_PROMISE)return a;b.prototype.asyncExecute=function(a){null==this.batch_&&(this.batch_=[],this.asyncExecuteBatch_());this.batch_.push(a);return this};b.prototype.asyncExecuteBatch_=function(){var a=this;this.asyncExecuteFunction(function(){a.executeBatch_()})};var d=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(a){d(a,
0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=this.batch_;this.batch_=[];for(var b=0;b<a.length;++b){var c=a[b];delete a[b];try{c()}catch(l){this.asyncThrow_(l)}}}this.batch_=null};b.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};var e=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var b=this.createResolveAndReject_();try{a(b.resolve,b.reject)}catch(k){b.reject(k)}};e.prototype.createResolveAndReject_=
function(){function a(a){return function(d){c||(c=!0,a.call(b,d))}}var b=this,c=!1;return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};e.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof e)this.settleSameAsPromise_(a);else{a:switch(typeof a){case "object":var b=null!=a;break a;case "function":b=!0;break a;default:b=!1}b?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};e.prototype.resolveToNonPromiseObj_=function(a){var b=
void 0;try{b=a.then}catch(k){this.reject_(k);return}"function"==typeof b?this.settleSameAsThenable_(b,a):this.fulfill_(a)};e.prototype.reject_=function(a){this.settle_(2,a)};e.prototype.fulfill_=function(a){this.settle_(1,a)};e.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b|"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};e.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=
this.onSettledCallbacks_,b=0;b<a.length;++b)a[b].call(),a[b]=null;this.onSettledCallbacks_=null}};var f=new b;e.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};e.prototype.settleSameAsThenable_=function(a,b){var c=this.createResolveAndReject_();try{a.call(b,c.resolve,c.reject)}catch(l){c.reject(l)}};e.prototype.then=function(a,b){function c(a,b){return"function"==typeof a?function(b){try{d(a(b))}catch(v){f(v)}}:b}var d,f,g=new e(function(a,
b){d=a;f=b});this.callWhenSettled_(c(a,d),c(b,f));return g};e.prototype["catch"]=function(a){return this.then(void 0,a)};e.prototype.callWhenSettled_=function(a,b){function c(){switch(d.state_){case 1:a(d.result_);break;case 2:b(d.result_);break;default:throw Error("Unexpected state: "+d.state_);}}var d=this;null==this.onSettledCallbacks_?f.asyncExecute(c):this.onSettledCallbacks_.push(function(){f.asyncExecute(c)})};e.resolve=c;e.reject=function(a){return new e(function(b,c){c(a)})};e.race=function(a){return new e(function(b,
d){for(var e=$jscomp.makeIterator(a),f=e.next();!f.done;f=e.next())c(f.value).callWhenSettled_(b,d)})};e.all=function(a){var b=$jscomp.makeIterator(a),d=b.next();return d.done?c([]):new e(function(a,e){function f(b){return function(c){g[b]=c;h--;0==h&&a(g)}}var g=[],h=0;do g.push(void 0),h++,c(d.value).callWhenSettled_(f(g.length-1),e),d=b.next();while(!d.done)})};return e},"es6","es3");
$jscomp.executeAsyncGenerator=function(a){function b(b){return a.next(b)}function c(b){return a["throw"](b)}return new Promise(function(d,e){function f(a){a.done?d(a.value):Promise.resolve(a.value).then(b,c).then(f,e)}f(a.next())})};function uint8ArrayToBase64Url(a,b,c){c=c||a.byteLength;return window.btoa(String.fromCharCode.apply(null,a.subarray(b||0,c))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}
function base64UrlToUint8Array(a){var b="=".repeat((4-a.length%4)%4);a=(a+b).replace(/\-/g,"+").replace(/_/g,"/");a=window.atob(a);b=new Uint8Array(a.length);for(var c=0;c<a.length;++c)b[c]=a.charCodeAt(c);return b}
function joinUint8Arrays(a){return a.reduce(function(a,c){if(!(c instanceof Uint8Array))throw console.error("Received an non-Uint8Array value:",c),Error("Received an non-Uint8Array value.");var b=new Uint8Array(a.byteLength+c.byteLength);b.set(a,0);b.set(c,a.byteLength);return b},new Uint8Array)}
function arrayBuffersToCryptoKeys(a,b){if(65!==a.byteLength)throw Error("The publicKey is expected to be 65 bytes.");var c=new Uint8Array(a);if(4!==c[0])throw Error("The publicKey is expected to start with an 0x04 byte.");c={kty:"EC",crv:"P-256",x:window.uint8ArrayToBase64Url(c,1,33),y:window.uint8ArrayToBase64Url(c,33,65),ext:!0};var d=[];d.push(crypto.subtle.importKey("jwk",c,{name:"ECDH",namedCurve:"P-256"},!0,[]));if(b){if(32!==b.byteLength)throw Error("The privateKey is expected to be 32 bytes.");
c.d=window.uint8ArrayToBase64Url(b);d.push(crypto.subtle.importKey("jwk",c,{name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]))}return Promise.all(d).then(function(a){var b={publicKey:a[0]};1<a.length&&(b.privateKey=a[1]);return b})}
function cryptoKeysToUint8Array(a,b){return Promise.resolve().then(function(){var c=[];c.push(crypto.subtle.exportKey("jwk",a).then(function(a){var b=window.base64UrlToUint8Array(a.x);a=window.base64UrlToUint8Array(a.y);var c=new Uint8Array(65);c.set([4],0);c.set(b,1);c.set(a,33);return c}));b&&c.push(crypto.subtle.exportKey("jwk",b).then(function(a){return window.base64UrlToUint8Array(a.d)}));return Promise.all(c)}).then(function(a){var b={publicKey:a[0]};1<a.length&&(b.privateKey=a[1]);return b})}
function generateSalt(){return crypto.getRandomValues(new Uint8Array(16))}
window?(window.uint8ArrayToBase64Url=uint8ArrayToBase64Url,window.base64UrlToUint8Array=base64UrlToUint8Array,window.joinUint8Arrays=joinUint8Arrays,window.arrayBuffersToCryptoKeys=arrayBuffersToCryptoKeys,window.cryptoKeysToUint8Array=cryptoKeysToUint8Array,window.generateSalt=generateSalt):module&&module.exports&&(module.exports={uint8ArrayToBase64Url:uint8ArrayToBase64Url,base64UrlToUint8Array:base64UrlToUint8Array,joinUint8Arrays:joinUint8Arrays,arrayBuffersToCryptoKeys:arrayBuffersToCryptoKeys,
cryptoKeysToUint8Array:cryptoKeysToUint8Array});var HMAC=function(a){this._ikm=a};HMAC.prototype.sign=function(a){return crypto.subtle.importKey("raw",this._ikm,{name:"HMAC",hash:"SHA-256"},!1,["sign"]).then(function(b){return crypto.subtle.sign("HMAC",b,a)})};"undefined"!==typeof window?(window.gauntface=window.gauntface||{},window.gauntface.HMAC=HMAC):module&&module.exports&&(module.exports=HMAC);var HKDF=function(a,b){this._ikm=a;this._salt=b;this._hmac=new HMAC(b)};
HKDF.prototype.generate=function(a,b){var c=new Uint8Array(a.byteLength+1);c.set(a,0);c.set((new Uint8Array(1)).fill(1),a.byteLength);return this._hmac.sign(this._ikm).then(function(a){return(new HMAC(a)).sign(c)}).then(function(a){return a.slice(0,b)})};"undefined"!==typeof window?(window.gauntface=window.gauntface||{},window.gauntface.HKDF=HKDF):module&&module.exports&&(module.exports=HKDF);var VapidHelper1=function(){};
VapidHelper1.createVapidAuthHeader=function(a,b,c,d){if(!b)return Promise.reject(Error("Audience must be the origin of the server"));if(!c)return Promise.reject(Error("Subject must be either a mailto or http link"));"number"!==typeof d&&(d=Math.floor(Date.now()/1E3+43200));var e=window.base64UrlToUint8Array(a.publicKey);a=window.base64UrlToUint8Array(a.privateKey);b=(new URL(b)).origin;b={aud:b,exp:d,sub:c};var f=new TextEncoder("utf-8"),g=window.uint8ArrayToBase64Url(f.encode(JSON.stringify({typ:"JWT",
alg:"ES256"})))+"."+window.uint8ArrayToBase64Url(f.encode(JSON.stringify(b)));b={kty:"EC",crv:"P-256",x:window.uint8ArrayToBase64Url(e.subarray(1,33)),y:window.uint8ArrayToBase64Url(e.subarray(33,65)),d:window.uint8ArrayToBase64Url(a)};return crypto.subtle.importKey("jwk",b,{name:"ECDSA",namedCurve:"P-256"},!0,["sign"]).then(function(a){return crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},a,f.encode(g))}).then(function(a){a=g+"."+window.uint8ArrayToBase64Url(new Uint8Array(a));var b=window.uint8ArrayToBase64Url(e);
return{Authorization:"WebPush "+a,"Crypto-Key":"p256ecdsa="+b}})};"undefined"!==typeof window&&(window.gauntface=window.gauntface||{},window.gauntface.VapidHelper1=VapidHelper1);var VapidHelper2=function(){};
VapidHelper2.createVapidAuthHeader=function(a,b,c,d){if(!b)return Promise.reject(Error("Audience must be the origin of the server"));if(!c)return Promise.reject(Error("Subject must be either a mailto or http link"));"number"!==typeof d&&(d=Math.floor(Date.now()/1E3+43200));var e=window.base64UrlToUint8Array(a.publicKey);a=window.base64UrlToUint8Array(a.privateKey);b=(new URL(b)).origin;b={aud:b,exp:d,sub:c};var f=new TextEncoder("utf-8"),g=window.uint8ArrayToBase64Url(f.encode(JSON.stringify({typ:"JWT",
alg:"ES256"})))+"."+window.uint8ArrayToBase64Url(f.encode(JSON.stringify(b)));b={kty:"EC",crv:"P-256",x:window.uint8ArrayToBase64Url(e.subarray(1,33)),y:window.uint8ArrayToBase64Url(e.subarray(33,65)),d:window.uint8ArrayToBase64Url(a)};return crypto.subtle.importKey("jwk",b,{name:"ECDSA",namedCurve:"P-256"},!0,["sign"]).then(function(a){return crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},a,f.encode(g))}).then(function(a){a=g+"."+window.uint8ArrayToBase64Url(new Uint8Array(a));var b=window.uint8ArrayToBase64Url(e);
return{Authorization:"vapid t="+a+", k="+b}})};"undefined"!==typeof window&&(window.gauntface=window.gauntface||{},window.gauntface.VapidHelper2=VapidHelper2);var EncryptionHelperAES128GCM=function(a){a=void 0===a?{}:a;this._b64ServerKeys=a.serverKeys;this._b64Salt=a.salt;this._b4VapidKeys=a.vapidKeys};
EncryptionHelperAES128GCM.prototype.getServerKeys=function(){return this._b64ServerKeys?window.arrayBuffersToCryptoKeys(window.base64UrlToUint8Array(this._b64ServerKeys.publicKey),window.base64UrlToUint8Array(this._b64ServerKeys.privateKey)):EncryptionHelperAES128GCM.generateServerKeys()};EncryptionHelperAES128GCM.prototype.getSalt=function(){return this._b64Salt?window.base64UrlToUint8Array(this._b64Salt):window.generateSalt()};
EncryptionHelperAES128GCM.prototype.getVapidKeys=function(){return this._b4VapidKeys?this._b4VapidKeys:window.gauntface.CONSTANTS.APPLICATION_KEYS};
EncryptionHelperAES128GCM.prototype.getRequestDetails=function(a,b){var c=this,d=window.gauntface.VapidHelper1,e=a.endpoint;0===e.indexOf("https://fcm.googleapis.com")&&(e=e.replace("fcm/send","wp"),d=window.gauntface.VapidHelper2);return d.createVapidAuthHeader(this.getVapidKeys(),a.endpoint,"mailto:simple-push-demo@gauntface.co.uk").then(function(d){return c.encryptPayload(a,b).then(function(a){var b=null,c={TTL:60};a?(b=a.cipherText,c["Content-Encoding"]="aes128gcm"):c["Content-Length"]=0;d&&Object.keys(d).forEach(function(a){c[a]=
d[a]});a={headers:c,endpoint:e};b&&(a.body=b);return Promise.resolve(a)})})};
EncryptionHelperAES128GCM.prototype.encryptPayload=function(a,b){var c=this;if(!b||0===b.trim().length)return Promise.resolve(null);var d=this.getSalt();return this.getServerKeys().then(function(e){return window.cryptoKeysToUint8Array(e.publicKey).then(function(f){return c._generateEncryptionKeys(a,d,e).then(function(a){return crypto.subtle.importKey("raw",a.contentEncryptionKey,"AES-GCM",!0,["decrypt","encrypt"]).then(function(b){a.contentEncryptionCryptoKey=b;return a})}).then(function(a){var c=
(new TextEncoder("utf-8")).encode(b),d=new Uint8Array(1);d.fill(0);d[0]=2;c=window.joinUint8Arrays([c,d]);return crypto.subtle.encrypt({name:"AES-GCM",tagLength:128,iv:a.nonce},a.contentEncryptionCryptoKey,c)}).then(function(a){return c._addEncryptionContentCodingHeader(a,e,d)}).then(function(a){return{cipherText:a,salt:window.uint8ArrayToBase64Url(d),publicServerKey:window.uint8ArrayToBase64Url(f.publicKey)}})})})};
EncryptionHelperAES128GCM.generateServerKeys=function(){return crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"])};EncryptionHelperAES128GCM.prototype._addEncryptionContentCodingHeader=function(a,b,c){return window.cryptoKeysToUint8Array(b.publicKey).then(function(b){var d=new Uint8Array([0,0,16,0]),f=new Uint8Array(1);f[0]=b.publicKey.byteLength;b=[c,d,f,b.publicKey,new Uint8Array(a)];return window.joinUint8Arrays(b).buffer})};
EncryptionHelperAES128GCM.prototype._generateEncryptionKeys=function(a,b,c){return Promise.all([this._generatePRK(a,c),this._generateCEKInfo(a,c),this._generateNonceInfo(a,c)]).then(function(a){var c=a[0];j;var d=a[1];a=a[2];var g=new HKDF(c,b);c=new HKDF(c,b);return Promise.all([g.generate(d,16),c.generate(a,12)])}).then(function(a){return{contentEncryptionKey:a[0],nonce:a[1]}})};
EncryptionHelperAES128GCM.prototype._generateCEKInfo=function(a,b){return Promise.resolve().then(function(){var a=(new TextEncoder("utf-8")).encode("Content-Encoding: aes128gcm"),b=(new Uint8Array(1)).fill(0);return window.joinUint8Arrays([a,b])})};EncryptionHelperAES128GCM.prototype._generateNonceInfo=function(a,b){return Promise.resolve().then(function(){var a=(new TextEncoder("utf-8")).encode("Content-Encoding: nonce"),b=(new Uint8Array(1)).fill(0);return window.joinUint8Arrays([a,b])})};
EncryptionHelperAES128GCM.prototype._generatePRK=function(a,b){var c=this;return this._getSharedSecret(a,b).then(function(d){return c._getKeyInfo(a,b).then(function(b){return(new HKDF(d,a.getKey("auth"))).generate(b,32)})})};
EncryptionHelperAES128GCM.prototype._getSharedSecret=function(a,b){return Promise.resolve().then(function(){return window.arrayBuffersToCryptoKeys(a.getKey("p256dh"))}).then(function(a){return a.publicKey}).then(function(a){if(!(a instanceof CryptoKey))throw Error("The publicKey must be a CryptoKey.");return crypto.subtle.deriveBits({name:"ECDH",namedCurve:"P-256","public":a},b.privateKey,256)})};
EncryptionHelperAES128GCM.prototype._getKeyInfo=function(a,b){var c=new TextEncoder("utf-8");return window.cryptoKeysToUint8Array(b.publicKey).then(function(b){return window.joinUint8Arrays([c.encode("WebPush: info"),(new Uint8Array(1)).fill(0),new Uint8Array(a.getKey("p256dh")),b.publicKey])})};"undefined"!==typeof window&&(window.gauntface=window.gauntface||{},window.gauntface.EncryptionHelperAES128GCM=EncryptionHelperAES128GCM);
var EncryptionHelperAESGCM=function(a){a=void 0===a?{}:a;this._b64ServerKeys=a.serverKeys;this._b64Salt=a.salt;this._b4VapidKeys=a.vapidKeys};EncryptionHelperAESGCM.prototype.getServerKeys=function(){return this._b64ServerKeys?window.arrayBuffersToCryptoKeys(window.base64UrlToUint8Array(this._b64ServerKeys.publicKey),window.base64UrlToUint8Array(this._b64ServerKeys.privateKey)):EncryptionHelperAESGCM.generateServerKeys()};
EncryptionHelperAESGCM.prototype.getSalt=function(){return this._b64Salt?window.base64UrlToUint8Array(this._b64Salt):window.generateSalt()};EncryptionHelperAESGCM.prototype.getVapidKeys=function(){return this._b4VapidKeys?this._b4VapidKeys:window.gauntface.CONSTANTS.APPLICATION_KEYS};
EncryptionHelperAESGCM.prototype.getRequestDetails=function(a,b){var c=this;return VapidHelper1.createVapidAuthHeader(this.getVapidKeys(),a.endpoint,"mailto:simple-push-demo@gauntface.co.uk").then(function(d){return c.encryptPayload(a,b).then(function(b){var c=null,e={TTL:60};b?(c=b.cipherText,e.Encryption="salt="+b.salt,e["Crypto-Key"]="dh="+b.publicServerKey,e["Content-Encoding"]="aesgcm"):e["Content-Length"]=0;d&&Object.keys(d).forEach(function(a){e[a]=e[a]?e[a]+"; "+d[a]:d[a]});b={headers:e,endpoint:a.endpoint};
c&&(b.body=c);return Promise.resolve(b)})})};
EncryptionHelperAESGCM.prototype.encryptPayload=function(a,b){var c=this;if(!b||0===b.trim().length)return Promise.resolve(null);var d=this.getSalt();return this.getServerKeys().then(function(e){return window.cryptoKeysToUint8Array(e.publicKey).then(function(f){return c._generateEncryptionKeys(a,d,e).then(function(a){return crypto.subtle.importKey("raw",a.contentEncryptionKey,"AES-GCM",!0,["decrypt","encrypt"]).then(function(b){a.contentEncryptionCryptoKey=b;return a})}).then(function(a){var c=new Uint8Array(2),
d=(new TextEncoder("utf-8")).encode(b),e=new Uint8Array(c.byteLength+d.byteLength);e.set(c,0);e.set(d,c.byteLength);return crypto.subtle.encrypt({name:"AES-GCM",tagLength:128,iv:a.nonce},a.contentEncryptionCryptoKey,e)}).then(function(a){return{cipherText:a,salt:window.uint8ArrayToBase64Url(d),publicServerKey:window.uint8ArrayToBase64Url(f.publicKey)}})})})};EncryptionHelperAESGCM.generateServerKeys=function(){return crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"])};
EncryptionHelperAESGCM.prototype._generateEncryptionKeys=function(a,b,c){return Promise.all([this._generatePRK(a,c),this._generateCEKInfo(a,c),this._generateNonceInfo(a,c)]).then(function(a){var c=a[0],d=a[1];a=a[2];var g=new HKDF(c,b);c=new HKDF(c,b);return Promise.all([g.generate(d,16),c.generate(a,12)])}).then(function(a){return{contentEncryptionKey:a[0],nonce:a[1]}})};
EncryptionHelperAESGCM.prototype._generateContext=function(a,b){return Promise.resolve().then(function(){return window.arrayBuffersToCryptoKeys(a.getKey("p256dh"))}).then(function(a){return a.publicKey}).then(function(a){return{clientPublicKey:a,serverPublicKey:b.publicKey}}).then(function(a){return Promise.all([window.cryptoKeysToUint8Array(a.clientPublicKey),window.cryptoKeysToUint8Array(a.serverPublicKey)]).then(function(a){return{clientPublicKey:a[0].publicKey,serverPublicKey:a[1].publicKey}})}).then(function(a){var b=
(new TextEncoder("utf-8")).encode("P-256"),c=(new Uint8Array(1)).fill(0),f=new Uint8Array(2);f[0]=0;f[1]=a.clientPublicKey.byteLength;var g=new Uint8Array(2);g[0]=0;g[1]=a.serverPublicKey.byteLength;return window.joinUint8Arrays([b,c,f,a.clientPublicKey,g,a.serverPublicKey])})};
EncryptionHelperAESGCM.prototype._generateCEKInfo=function(a,b){var c=this;return Promise.resolve().then(function(){var d=(new TextEncoder("utf-8")).encode("Content-Encoding: aesgcm"),e=(new Uint8Array(1)).fill(0);return c._generateContext(a,b).then(function(a){return window.joinUint8Arrays([d,e,a])})})};
EncryptionHelperAESGCM.prototype._generateNonceInfo=function(a,b){var c=this;return Promise.resolve().then(function(){var d=(new TextEncoder("utf-8")).encode("Content-Encoding: nonce"),e=(new Uint8Array(1)).fill(0);return c._generateContext(a,b).then(function(a){return window.joinUint8Arrays([d,e,a])})})};
EncryptionHelperAESGCM.prototype._generatePRK=function(a,b){return this._getSharedSecret(a,b).then(function(b){var c=(new TextEncoder("utf-8")).encode("Content-Encoding: auth\x00");return(new HKDF(b,a.getKey("auth"))).generate(c,32)})};
EncryptionHelperAESGCM.prototype._getSharedSecret=function(a,b){return Promise.resolve().then(function(){return window.arrayBuffersToCryptoKeys(a.getKey("p256dh"))}).then(function(a){return a.publicKey}).then(function(a){if(!(a instanceof CryptoKey))throw Error("The publicKey must be a CryptoKey.");return crypto.subtle.deriveBits({name:"ECDH",namedCurve:"P-256","public":a},b.privateKey,256)})};
"undefined"!==typeof window&&(window.gauntface=window.gauntface||{},window.gauntface.EncryptionHelperAESGCM=EncryptionHelperAESGCM);
var Ruleta=function(a,b,c){c=void 0===c?{}:c;this.document=a;this.window=b;this.remote=c;this.numbers=[0,2,14,35,23,4,16,33,21,6,18,31,19,8,12,29,25,10,27,"00",1,13,36,24,3,15,34,22,5,17,32,20,7,11,30,26,9,28];this.playerEmail=this.playerName=null;this.name="Guest";this.email="example@example.com";this.audio=this.gameDiv=this.wheelDiv=this.ballSpot=this.board=this.wheel=null};
Ruleta.prototype.initAll=function(a){var b=this,c=this.document.createElement("div"),d=this.document.createElement("div"),e=this.document.createElement("div");c.appendChild(e);c.appendChild(d);a.appendChild(c);c.className="game";d.className="board";e.className="wheel";this.wheel=this.initWheel(e);this.board=this.initBoard(d);this.ballSpot=this.wheel[0];this.wheelDiv=e;this.wheelDiv.onclick=function(a){return b.play()};this.remote.playLocal&&this.remote.playLocal(function(a,c){b.setPlayer(a,c);b.play()});
this.remote.betLocal&&this.remote.betLocal(function(a,c){return b.board[a][c]()});this.gameDiv=c;this.board.bank.dataset.bet=100;this.audio=this.initAudio();this.window.localStorage.top10=this.window.localStorage.top10||JSON.stringify([{name:"Flag",email:"CTF{th3-r34L-fL46-g035-h3r3}@ctfcompetition.com",score:"Infinity"},{name:"ian",email:"ian@ian.ian",score:9.9E100},{name:"jennie",email:"j@en.ie",score:9E9},{name:"jan",email:"j@n",score:1E9},{name:"sanal",email:"sanal@san.al",score:9E8},{name:"sarah",
email:"s@r.ah",score:1E8},{name:"fei",email:"fei@fei.fei",score:9E7},{name:"federico",email:"federico@federi.com",score:1E7},{name:"ana",email:"iam@n.a",score:9E6},{name:"adrien",email:"a@dri.en",score:1E6}])};
Ruleta.prototype.initWheel=function(a){for(var b={},c,d="black",e=$jscomp.makeIterator(this.numbers),f=e.next();!f.done;f=e.next()){f=f.value;var g=this.document.createElement("div"),h=this.document.createElement("div"),k=0===1*f?"green":d;g.className="number "+k+" "+d;d="black"==d?"red":"black";g.dataset.number=f;g.dataset.color=k;h.appendChild(this.document.createTextNode(f));h.className="label";c=b[f]={wheel:g,number:f,color:k,prev:c};g.appendChild(h);a.appendChild(g);a=g}b[0].prev=c;return b};
Ruleta.prototype.initBoard=function(a){var b=this,c={},d=this.document.createElement("table"),e=this.document.createElement("tr"),f=this.document.createElement("tr"),g=this.document.createElement("tr"),h=this.document.createElement("tr"),k=this.document.createElement("tr");e.appendChild(this.wheel["00"].board=this.makeNumberTile(c,"00")).rowSpan=2;g.appendChild(this.wheel["0"].board=this.makeNumberTile(c,"0"));for(var l=3;36>=l;l+=3){var m=this.makeNumberTile(c,l),n=this.makeNumberTile(c,l-1),q=this.makeNumberTile(c,
l-2);e.appendChild(m);f.appendChild(n);g.appendChild(q)}l=this.makeCustomTile(c,"row1","2 to 1",3,"green");m=this.makeCustomTile(c,"row2","2 to 1",3,"green");n=this.makeCustomTile(c,"row3","2 to 1",3,"green");e.appendChild(l);f.appendChild(m);g.appendChild(n);l=h.appendChild(this.document.createElement("td"));l.className="player";m=l.appendChild(document.createElement("div"));l.rowSpan=2;var p=m.appendChild(document.createElement("input")),r=m.appendChild(document.createElement("input"));p.placeholder=
"name";r.placeholder="email";p.onchange=function(a){b.name=p.value};r.onchange=function(a){b.email=r.value};p.value=this.name;r.value=this.email;this.playerName=p;this.playerEmail=r;h.appendChild(this.makeCustomTile(c,"1st12","1st 12",3,"green")).colSpan=4;h.appendChild(this.makeCustomTile(c,"2nd12","2nd 12",3,"green")).colSpan=4;h.appendChild(this.makeCustomTile(c,"3rd12","3rd 12",3,"green")).colSpan=4;k.appendChild(this.makeCustomTile(c,"1to18","1 - 18",2,"green")).colSpan=2;k.appendChild(this.makeCustomTile(c,
"even","EVEN",2,"green")).colSpan=2;k.appendChild(this.makeCustomTile(c,"red","\u00a0",2,"red")).colSpan=2;k.appendChild(this.makeCustomTile(c,"black","\u00a0",2,"black")).colSpan=2;k.appendChild(this.makeCustomTile(c,"odd","ODD",2,"green")).colSpan=2;k.appendChild(this.makeCustomTile(c,"19to36","19 - 36",2,"green")).colSpan=2;h.appendChild(this.makeCustomTile(c,"bank","balance",1,"green")).rowSpan=2;d.appendChild(e);d.appendChild(f);d.appendChild(g);d.appendChild(h);d.appendChild(k);a.appendChild(d);
return c};Ruleta.prototype.makeNumberTile=function(a,b){var c=this.makeCustomTile(a,b,b,36,this.wheel[b].color,"circled"),d={};this.wheel[b].payout=(d.red="red"==this.wheel[b].color,d.black="black"==this.wheel[b].color,d.row1=0==b%3&&0!=b,d.row2=2==b%3,d.row3=1==b%3,d["1st12"]=1<=b&&13>b,d["2nd12"]=12<b&&25>b,d["3rd12"]=24<b&&36>=b,d["1to18"]=1<=b&&18>=b,d["19to36"]=19<=b&&36>=b,d.even=0==b%2&&0!=b,d.odd=1==b%2,d.bank=!0,d[b]=!0,d);return c};
Ruleta.prototype.makeCustomTile=function(a,b,c,d,e,f){var g=this;f=void 0===f?"":f;var h=this.document.createElement("td");h.dataset.id=b;h.dataset.payout=d;h.dataset.bet=0;h.onclick=function(c){0<a.bank.dataset.bet&&(h.dataset.bet++,a.bank.dataset.bet--,g.remote.betRemote&&g.remote.betRemote(b,"onclick"))};h.onauxclick=function(c){0<h.dataset.bet&&(h.dataset.bet--,a.bank.dataset.bet++,g.remote.betRemote&&g.remote.betRemote(b,"onauxclick"))};h.oncontextmenu=function(a){return!1};h.className="tile";
d=this.document.createElement("div");d.className="label "+f+" "+e;d.appendChild(this.document.createTextNode(c));h.appendChild(d);return a[b]=h};Ruleta.prototype.initAudio=function(){var a=new AudioContext,b=a.createOscillator(),c=a.createGain();b.connect(c);c.connect(a.destination);b.type="triangle";b.frequency.value=87.31;b.start(0);c.gain.value=1E-5;return{context:a,g:c,o:b}};
Ruleta.prototype.getTop10=function(a){var b=this;return $jscomp.executeAsyncGenerator(function(){function c(c,f,k){for(;;)switch(d){case 0:if(!b.remote.getTop10Remote){d=1;break}d=-1;return{value:b.remote.getTop10Remote(),done:!0};case 1:return e=JSON.parse(b.window.localStorage.top10),e.push({name:b.name,email:b.email,score:b.board.bank.dataset.bet}),e=e.sort(function(a,b){return b.score-a.score}).slice(0,10),a?b.window.localStorage.top10=JSON.stringify(e):e.forEach(function(a){return a.email=a.email.replace(/(.{4}).*@(.*)(?:add-some-privacy){0}/g,
"$1...@$2")}),d=-1,{value:e,done:!0};default:return{value:void 0,done:!0}}}var d=0,e,f={next:function(a){return c(0,a,void 0)},"throw":function(a){return c(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();f[Symbol.iterator]=function(){return this};return f}())};Ruleta.prototype.setPlayer=function(a,b){this.playerName.value=this.name=a;this.playerEmail.value=this.email=b};
Ruleta.prototype.spinWheelLocal=function(a){var b=this;return new Promise(function(c){var d=!1,e=!1,f=b.ballSpot,g=function(){f.wheel.dataset.ball=!1;f=f.prev;f.wheel.dataset.ball=!0;e=d&&String(f.number)==String(a);if(b.remote.spinWheelMoveBallLocal){var h=b.window.getComputedStyle(b.wheelDiv).rotate;b.remote.spinWheelMoveBallLocal(f.number,h,!e)}e?c(b.ballSpot=f):b.window.requestAnimationFrame(g)};g();b.gameDiv.dataset.spin=!1;b.window.requestAnimationFrame(function(a){b.gameDiv.dataset.spin=!0});
b.window.setTimeout(function(a){d=!0},8E3)})};
Ruleta.prototype.spinWheelRemote=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,p,t){for(;;)switch(c){case 0:a.gameDiv.dataset.spin="fake";if(!a.remote.spinWheelMoveBallRemote){c=1;break}q=a.remote.spinWheelMoveBallRemote();case 2:if(!q){c=3;break}c=4;return{value:q,done:!1};case 4:if(1!=b){c=5;break}c=-1;throw t;case 5:m=n=p;l=m.rotate;k=m.number;h=m.next;g=a.ballSpot;f=a.ballSpot=a.wheel[k];a.wheelDiv.style.rotate=l;g.wheel.dataset.ball=!1;f.wheel.dataset.ball=
!0;q=h;c=2;break;case 3:case 1:return c=6,{value:a.remote.spinWheelRemote(),done:!1};case 6:if(1!=b){c=7;break}c=-1;throw t;case 7:return d=e=p,a.ballSpot=a.wheel[d],c=-1,{value:a.ballSpot,done:!0};default:return{value:void 0,done:!0}}}var c=0,d,e,f,g,h,k,l,m,n,q,p={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();p[Symbol.iterator]=function(){return this};return p}())};
Ruleta.prototype.spinWheel=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,g,l){for(;;)switch(c){case 0:f=a.window.setInterval(function(b){a.audio.g.gain.exponentialRampToValueAtTime(1,a.audio.context.currentTime);a.audio.g.gain.exponentialRampToValueAtTime(1E-5,a.audio.context.currentTime+1)},100);a.window.setTimeout(function(b){a.window.clearInterval(f)},8E3);if(!a.remote.spinWheelRemote){c=1;break}c=-1;return{value:a.spinWheelRemote(),done:!0};case 1:return c=
2,{value:a.getRandom(a.numbers.length),done:!1};case 2:if(1!=b){c=3;break}c=-1;throw l;case 3:return d=e=g,c=-1,{value:a.spinWheelLocal(a.numbers[d]),done:!0};default:return{value:void 0,done:!0}}}var c=0,d,e,f,g={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();g[Symbol.iterator]=function(){return this};return g}())};
Ruleta.prototype.getRandom=function(a){return $jscomp.executeAsyncGenerator(function(){function b(b,d,g){for(;;)switch(c){case 0:return c=-1,{value:Math.floor(a*crypto.getRandomValues(new Uint8Array(1))[0]/255),done:!0};default:return{value:void 0,done:!0}}}var c=0,d={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();d[Symbol.iterator]=function(){return this};return d}())};
Ruleta.prototype.playLocal=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,l,q){for(;;)switch(c){case 0:k={};for(var m in a.board)k[m]={bet:a.board[m].dataset.bet,payout:a.board[m].dataset.payout};c=1;return{value:a.spinWheel(),done:!1};case 1:if(1!=b){c=2;break}c=-1;throw q;case 2:g=h=l;f={};for(var n in k)f[n]={},g.payout[n]?(f[n].bet=k[n].bet*k[n].payout,f[n].lost=!1):(f[n].lost=0!=a.board[n].dataset.bet,f[n].bet=0);if(!a.remote.spinWheelLocal){c=3;break}c=4;
return{value:a.getTop10(!1),done:!1};case 4:if(1!=b){c=5;break}c=-1;throw q;case 5:d=e=l,a.remote.spinWheelLocal({number:g.number,results:f,top10:d});case 3:return c=-1,{value:f,done:!0};default:return{value:void 0,done:!0}}}var c=0,d,e,f,g,h,k,l={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();l[Symbol.iterator]=function(){return this};return l}())};
Ruleta.prototype.playRemote=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,f,k){for(;;)switch(c){case 0:return e=a.remote.playRemote({name:a.name,email:a.email}),c=1,{value:a.spinWheel(),done:!1};case 1:if(1!=b){c=2;break}c=-1;throw k;case 2:return c=3,{value:e,done:!1};case 3:if(1!=b){c=4;break}c=-1;throw k;case 4:return d=f,c=-1,{value:d,done:!0};default:return{value:void 0,done:!0}}}var c=0,d,e,f={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,
void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();f[Symbol.iterator]=function(){return this};return f}())};
Ruleta.prototype.play=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,k,n){for(;;)switch(c){case 0:if(!a.remote.playRemote){c=1;break}c=3;return{value:a.playRemote(),done:!1};case 3:if(1!=b){c=4;break}c=-1;throw n;case 4:h=g=k;c=2;break;case 1:return c=5,{value:a.playLocal(),done:!1};case 5:if(1!=b){c=6;break}c=-1;throw n;case 6:h=f=k;case 2:for(var l in h)a.board[l].dataset.bet=h[l].bet,a.board[l].dataset.lost=h[l].lost;c=7;return{value:a.getTop10(!0),done:!1};
case 7:if(1!=b){c=8;break}c=-1;throw n;case 8:return d=e=k,a.window.top10.innerHTML="<ol>"+d.map(function(a){return"<li>"+a.name.link("mailto:"+a.email)+": "+a.score}).join("")+"</ol>",c=-1,{value:h,done:!0};default:return{value:void 0,done:!0}}}var c=0,d,e,f,g,h,k={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();k[Symbol.iterator]=function(){return this};return k}())};
var RuletaLocal=function(a,b){this.messageSender=a;this.messageListener=b};RuletaLocal.prototype.spinWheelMoveBallLocal=function(a,b,c){this.messageSender.send({type:"spinWheelMoveBall",value:{number:a,rotate:b,next:c}})};RuletaLocal.prototype.spinWheelLocal=function(a){this.messageSender.send({type:"spinWheel",value:a})};RuletaLocal.prototype.playLocal=function(a){this.messageListener.listen(function(b){"play"==b.type&&a(b.value.name,b.value.email)})};
RuletaLocal.prototype.betLocal=function(a){this.messageListener.listen(function(b){"bet"==b.type&&a(b.value.tile,b.value.event)})};var RuletaRemota=function(a,b){this.messageSender=a;this.messageListener=b;this.nextSpin=new Promise(this.resolver.bind(this,"spinWheelMoveBall"));this.result=null};RuletaRemota.prototype.resolver=function(a,b,c){this.messageListener.listen(function(c){if(c.type==a)return b(c.value),!0})};
RuletaRemota.prototype.spinWheelMoveBallRemote=function(a){a=void 0===a?null:a;var b=this;return $jscomp.executeAsyncGenerator(function(){function c(c,h,m){for(;;)switch(d){case 0:if(!(g=a)){d=1;break}d=2;break;case 1:return d=3,{value:b.nextSpin,done:!1};case 3:if(1!=c){d=4;break}d=-1;throw m;case 4:g=f=h;case 2:return e=g,e.next&&(e.next=(new Promise(b.resolver.bind(b,"spinWheelMoveBall"))).then(function(a){return b.spinWheelMoveBallRemote(a)})),d=-1,{value:e,done:!0};default:return{value:void 0,
done:!0}}}var d=0,e,f,g,h={next:function(a){return c(0,a,void 0)},"throw":function(a){return c(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();h[Symbol.iterator]=function(){return this};return h}())};
RuletaRemota.prototype.spinWheelRemote=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,e,h){for(;;)switch(c){case 0:return c=1,{value:a.result,done:!1};case 1:if(1!=b){c=2;break}c=-1;throw h;case 2:return d=e,c=-1,{value:d.number,done:!0};default:return{value:void 0,done:!0}}}var c=0,d,e={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();e[Symbol.iterator]=
function(){return this};return e}())};
RuletaRemota.prototype.playRemote=function(a){var b=this;return $jscomp.executeAsyncGenerator(function(){function c(c,f,k){for(;;)switch(d){case 0:return b.result=new Promise(b.resolver.bind(b,"spinWheel")),b.messageSender.send({type:"play",value:a}),d=1,{value:b.result,done:!1};case 1:if(1!=c){d=2;break}d=-1;throw k;case 2:return e=f,d=-1,{value:e.results,done:!0};default:return{value:void 0,done:!0}}}var d=0,e,f={next:function(a){return c(0,a,void 0)},"throw":function(a){return c(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");
}};$jscomp.initSymbolIterator();f[Symbol.iterator]=function(){return this};return f}())};
RuletaRemota.prototype.betRemote=function(a,b){var c=this;return $jscomp.executeAsyncGenerator(function(){function d(d,f,k){for(;;)switch(e){case 0:c.messageSender.send({type:"bet",value:{tile:a,event:b}}),e=-1;default:return{value:void 0,done:!0}}}var e=0,f={next:function(a){return d(0,a,void 0)},"throw":function(a){return d(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();f[Symbol.iterator]=function(){return this};return f}())};
RuletaRemota.prototype.getTop10Remote=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,e,h){for(;;)switch(c){case 0:return c=1,{value:a.result,done:!1};case 1:if(1!=b){c=2;break}c=-1;throw h;case 2:return d=e,c=-1,{value:d.top10,done:!0};default:return{value:void 0,done:!0}}}var c=0,d,e={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();e[Symbol.iterator]=
function(){return this};return e}())};var MessageListener=function(){this.fns=[]};MessageListener.prototype.handle=function(a){a=JSON.parse(a);this.fns=this.fns.filter(function(b){try{return!b(a)}catch(c){}return!0})};MessageListener.prototype.listen=function(a){this.fns.push(a)};var MessageSenderX=function(){this.pending=[];this.sendFunction=null};MessageSenderX.prototype.send=function(a){a=JSON.stringify(a);if(this.sendFunction)return this.sendFunction(a);this.pending.push(a)};
MessageSenderX.prototype.setSender=function(a){this.sendFunction=a;a=$jscomp.makeIterator(this.pending);for(var b=a.next();!b.done;b=a.next())msg=b.value,this.send(msg);this.pending=[]};
var Comms=function(a){this.key={x:"V7QlgXmOiS_qYiII-pqvyuBBAr8e0cWYMYmsXxB41pA",y:"mwtxIkIZyFF0QIBnnMx3yXDOE2eS-7HcmG6260aPJQs",d:"fMJiRf3caw57MXGrFn-YuVcdjfyne0Y6rxKsvKK-1DI"};this.key.serverKey=new Uint8Array(("\u0004"+this.base64decode(this.key.x)+this.base64decode(this.key.y)).split("").map(function(a){return a.charCodeAt()}));this.key.encodedPublicKey=this.base64encode(String.fromCharCode.apply(null,this.key.serverKey));this.window=a;a.gauntface.CONSTANTS={APPLICATION_KEYS:{publicKey:this.key.encodedPublicKey,
privateKey:this.key.d}};this.workerUrl="worker.js";this.proxy=function(a){return fetch(a.url,a)};this.window=a;this.pushMessageFns=[];this.subscription=this.pushManager=this.cryptoHelper=this.offer=this.channel=this.localAnswer=this.rtcConnection=null};
Comms.prototype.initPush=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,g,l){for(;;)switch(c){case 0:return c=1,{value:a.window.navigator.serviceWorker.getRegistration(),done:!1};case 1:if(1!=b){c=2;break}c=-1;throw l;case 2:if(e=f=g){c=3;break}c=4;return{value:a.window.navigator.serviceWorker.register(a.workerUrl),done:!1};case 4:if(1!=b){c=5;break}c=-1;throw l;case 5:a.window.location.reload();case 3:a.pushManager=e.pushManager,a.cryptoHelper=new EncryptionHelperAESGCM,
d=new MessageChannel,e.active.postMessage("push",[d.port1]),d.port2.onmessage=function(b){a.distributePushMessages(b.data)},c=-1;default:return{value:void 0,done:!0}}}var c=0,d,e,f,g={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();g[Symbol.iterator]=function(){return this};return g}())};
Comms.prototype.initRTC=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,e,h){for(;;)switch(c){case 0:d={iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"},{url:"turn:35.195.85.49:3478",credential:"ekXUNWC7GT2aOzP77H",username:"gctf2017",hint:"this is not part of the challenge"}]},a.rtcConnection=new RTCPeerConnection(d),
c=-1;default:return{value:void 0,done:!0}}}var c=0,d,e={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();e[Symbol.iterator]=function(){return this};return e}())};
Comms.prototype.init=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,d,g){for(;;)switch(c){case 0:return c=-1,{value:Promise.all([a.initPush(),a.initRTC()]),done:!0};default:return{value:void 0,done:!0}}}var c=0,d={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();d[Symbol.iterator]=function(){return this};return d}())};
Comms.prototype.subscribePush=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,f,k){for(;;)switch(c){case 0:return e=a,c=1,{value:a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:a.key.serverKey}),done:!1};case 1:if(1!=b){c=2;break}c=-1;throw k;case 2:return d=f,c=-1,{value:e.subscription=d,done:!0};default:return{value:void 0,done:!0}}}var c=0,d,e,f={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");
}};$jscomp.initSymbolIterator();f[Symbol.iterator]=function(){return this};return f}())};
Comms.prototype.sendPushMessage=function(a,b){var c=this;return $jscomp.executeAsyncGenerator(function(){function d(d,h,m){for(;;)switch(e){case 0:return e=1,{value:c.cryptoHelper.getRequestDetails(c.fixSubscription(a),JSON.stringify(b)),done:!1};case 1:if(1!=d){e=2;break}e=-1;throw m;case 2:return f=g=h,f.method="post",f.url=f.endpoint,e=-1,{value:c.proxy(f),done:!0};default:return{value:void 0,done:!0}}}var e=0,f,g,h={next:function(a){return d(0,a,void 0)},"throw":function(a){return d(1,void 0,
a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();h[Symbol.iterator]=function(){return this};return h}())};Comms.prototype.receivePushMessages=function(a){this.pushMessageFns.push(a)};
Comms.prototype.distributePushMessages=function(a){var b=this;return $jscomp.executeAsyncGenerator(function(){function c(c,e,h){for(;;)switch(d){case 0:b.pushMessageFns.forEach(function(b){try{b(a)}catch(l){Promise.reject(l)}}),d=-1;default:return{value:void 0,done:!0}}}var d=0,e={next:function(a){return c(0,a,void 0)},"throw":function(a){return c(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();e[Symbol.iterator]=function(){return this};return e}())};
Comms.prototype.fixSubscription=function(a){var b=this;a.getKey=function(c){return new Uint8Array(b.base64decode(a.keys[c]).split("").map(function(a){return a.charCodeAt()}))};return a};
Comms.prototype.createRTCChannel=function(a){var b=this;return $jscomp.executeAsyncGenerator(function(){function c(c,g,l){for(;;)switch(d){case 0:return b.channel=b.rtcConnection.createDataChannel("sendDataChannel",null),f=b,d=1,{value:b.rtcConnection.createOffer(),done:!1};case 1:if(1!=c){d=2;break}d=-1;throw l;case 2:return e=g,f.offer=e,d=3,{value:b.rtcConnection.setLocalDescription(b.offer),done:!1};case 3:if(1!=c){d=4;break}d=-1;throw l;case 4:return b.rtcConnection.onicecandidate=function(b){b.candidate&&
a(b.candidate)},d=-1,{value:{localOffer:b.offer,channel:b.channel},done:!0};default:return{value:void 0,done:!0}}}var d=0,e,f,g={next:function(a){return c(0,a,void 0)},"throw":function(a){return c(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();g[Symbol.iterator]=function(){return this};return g}())};
Comms.prototype.acceptRTCChannel=function(a){var b=this;return $jscomp.executeAsyncGenerator(function(){function c(c,e,h){for(;;)switch(d){case 0:return d=1,{value:b.rtcConnection.setRemoteDescription(a),done:!1};case 1:if(1!=c){d=2;break}d=-1;throw h;case 2:d=-1;default:return{value:void 0,done:!0}}}var d=0,e={next:function(a){return c(0,a,void 0)},"throw":function(a){return c(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();e[Symbol.iterator]=
function(){return this};return e}())};
Comms.prototype.openRTCChannel=function(a,b){var c=this;return $jscomp.executeAsyncGenerator(function(){function d(d,k,n){for(;;)switch(e){case 0:return e=1,{value:c.rtcConnection.setRemoteDescription(a),done:!1};case 1:if(1!=d){e=2;break}e=-1;throw n;case 2:return c.rtcConnection.onicecandidate=function(a){a.candidate&&b(a.candidate)},h=new Promise(function(a){c.rtcConnection.ondatachannel=function(b){b.channel&&a(c.channel=b.channel)}}),g=c,e=3,{value:c.rtcConnection.createAnswer(),done:!1};case 3:if(1!=
d){e=4;break}e=-1;throw n;case 4:return f=k,g.localAnswer=f,e=5,{value:c.rtcConnection.setLocalDescription(c.localAnswer),done:!1};case 5:if(1!=d){e=6;break}e=-1;throw n;case 6:return e=-1,{value:{localAnswer:c.localAnswer,channelPromise:h},done:!0};default:return{value:void 0,done:!0}}}var e=0,f,g,h,k={next:function(a){return d(0,a,void 0)},"throw":function(a){return d(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();k[Symbol.iterator]=function(){return this};
return k}())};Comms.prototype.addCandidate=function(a){this.rtcConnection.addIceCandidate(a)};Comms.prototype.base64encode=function(a){return btoa(a).replace(/[+]/g,"-").replace(/[/]/g,"_")};Comms.prototype.base64decode=function(a){return atob(a.replace(/-/g,"+").replace(/_/g,"/"))};var GameHosting=function(a){this.window=a;this.comms=this.channel=this.clientOffer=this.clientSubscription=this.serverSubscription=null};
GameHosting.prototype.init=function(a){var b=this;return $jscomp.executeAsyncGenerator(function(){function c(c,k,n){for(;;)switch(d){case 0:return b.comms=new Comms(b.window),d=1,{value:b.comms.init(),done:!1};case 1:if(1!=c){d=2;break}d=-1;throw n;case 2:return h=b,d=3,{value:b.comms.subscribePush(),done:!1};case 3:if(1!=c){d=4;break}d=-1;throw n;case 4:g=k,h.serverSubscription=g,f=[],e=!1,b.comms.receivePushMessages(function(c){"clientCandidate"==c.type&&(f.push(c.clientCandidate),e&&b.comms.addCandidate(c.clientCandidate));
"clientOffer"==c.type&&(e=!0,a(c,f))}),d=-1;default:return{value:void 0,done:!0}}}var d=0,e,f,g,h,k={next:function(a){return c(0,a,void 0)},"throw":function(a){return c(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();k[Symbol.iterator]=function(){return this};return k}())};GameHosting.prototype.setClient=function(a,b){this.clientSubscription=a;this.clientOffer=b};
GameHosting.prototype.getChannel=function(a){var b=this;return $jscomp.executeAsyncGenerator(function(){function c(c,m,p){for(;;)switch(d){case 0:return d=1,{value:b.comms.openRTCChannel(b.clientOffer,function(a){return b.sendCandidate(a)}),done:!1};case 1:if(1!=c){d=2;break}d=-1;throw p;case 2:k=l=m;h=k.localAnswer;g=k.channelPromise;c=$jscomp.makeIterator(a);for(m=c.next();!m.done;m=c.next())b.comms.addCandidate(m.value);b.comms.sendPushMessage(b.clientSubscription,{type:"serverAnswer",serverAnswer:h});
f=b;d=3;return{value:g,done:!1};case 3:if(1!=c){d=4;break}d=-1;throw p;case 4:return e=m,d=-1,{value:f.channel=e,done:!0};default:return{value:void 0,done:!0}}}var d=0,e,f,g,h,k,l,m={next:function(a){return c(0,a,void 0)},"throw":function(a){return c(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();m[Symbol.iterator]=function(){return this};return m}())};
GameHosting.prototype.sendCandidate=function(a){this.comms.sendPushMessage(this.clientSubscription,{type:"serverCandidate",serverCandidate:a})};var GameClient=function(a){this.window=a;this.comms=this.channelPromise=this.clientSubscription=this.serverSubscription=null};
GameClient.prototype.init=function(a){var b=this;return $jscomp.executeAsyncGenerator(function(){function c(c,m,p){for(;;)switch(d){case 0:return b.comms=new Comms(b.window),d=1,{value:b.comms.init(),done:!1};case 1:if(1!=c){d=2;break}d=-1;throw p;case 2:return b.serverSubscription=a,l=b,d=3,{value:b.comms.subscribePush(),done:!1};case 3:if(1!=c){d=4;break}d=-1;throw p;case 4:return k=m,l.clientSubscription=k,d=5,{value:b.comms.createRTCChannel(function(a){return b.sendCandidate(a)}),done:!1};case 5:if(1!=
c){d=6;break}d=-1;throw p;case 6:g=h=m,f=g.localOffer,e=g.channel,b.channelPromise=new Promise(function(a){e.onopen=function(b){return a(e)}}),b.comms.receivePushMessages(function(a){"serverAnswer"==a.type&&b.comms.acceptRTCChannel(a.serverAnswer);"serverCandidate"==a.type&&b.comms.addCandidate(a.serverCandidate)}),b.comms.sendPushMessage(a,{type:"clientOffer",clientSubscription:b.clientSubscription,clientOffer:f}),d=-1;default:return{value:void 0,done:!0}}}var d=0,e,f,g,h,k,l,m={next:function(a){return c(0,
a,void 0)},"throw":function(a){return c(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();m[Symbol.iterator]=function(){return this};return m}())};
GameClient.prototype.getChannel=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,f,k){for(;;)switch(c){case 0:return c=1,{value:a.channelPromise,done:!1};case 1:if(1!=b){c=2;break}c=-1;throw k;case 2:return d=e=f,c=-1,{value:d,done:!0};default:return{value:void 0,done:!0}}}var c=0,d,e,f={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();f[Symbol.iterator]=
function(){return this};return f}())};GameClient.prototype.sendCandidate=function(a){this.comms.sendPushMessage(this.serverSubscription,{type:"clientCandidate",clientCandidate:a})};var Glue=function(a,b){this.window=a;this.document=b;this.server=this.client=null};
Glue.prototype.init=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,f,k){for(;;)switch(c){case 0:if(e=a.window.location.hash.substr(1)){c=1;break}c=-1;return{value:a.initServer(),done:!0};case 1:d=a.decode(e);if(!("serverSubscription"in d)){c=3;break}c=-1;return{value:a.initClient(d.serverSubscription),done:!0};case 3:console.error("Invalid init data",d),a.window.location.hash="",a.window.location.reload();case 4:case 2:c=-1;default:return{value:void 0,done:!0}}}
var c=0,d,e,f={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();f[Symbol.iterator]=function(){return this};return f}())};Glue.prototype.encode=function(a){return encodeURIComponent(btoa(JSON.stringify(a)))};Glue.prototype.decode=function(a){return JSON.parse(atob(decodeURIComponent(a)))};
Glue.prototype.initServer=function(){var a=this;return $jscomp.executeAsyncGenerator(function(){function b(b,g,l){for(;;)switch(c){case 0:return table.innerHTML="Waiting for player..",f=new GameHosting(a.window),e=a.window.setTimeout(function(a){location.reload()},3E4),c=1,{value:f.init(function(b,c){return $jscomp.executeAsyncGenerator(function(){function d(d,p,q){for(;;)switch(g){case 0:if(!f.clientOffer){g=1;break}location.reload();g=-1;return{value:void 0,done:!0};case 1:return a.window.clearTimeout(e),
f.setClient(b.clientSubscription,b.clientOffer),g=2,{value:f.getChannel(c),done:!1};case 2:if(1!=d){g=3;break}g=-1;throw q;case 3:return n=w=p,n.onclose=function(b){return a.window.location.reload()},table.innerHTML="",m=new MessageSenderX,l=new MessageListener,m.setSender(function(a){return n.send(a)}),n.onmessage=function(a){return l.handle(a.data)},k=a,g=4,{value:(new Ruleta(a.window.document,a.window,new RuletaLocal(m,l))).initAll(table),done:!1};case 4:if(1!=d){g=5;break}g=-1;throw q;case 5:h=
p,k.server=h,g=-1;default:return{value:void 0,done:!0}}}var g=0,h,k,l,m,n,w,u={next:function(a){return d(0,a,void 0)},"throw":function(a){return d(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();u[Symbol.iterator]=function(){return this};return u}())}),done:!1};case 1:if(1!=b){c=2;break}c=-1;throw l;case 2:d=location.origin+location.pathname+"?join#"+a.encode({serverSubscription:f.serverSubscription}),console.log("Invite URL",d),inviteLink.href=
"mailto:?subject=Invite&body="+escape("Let's play Flag Roullete!\n\n"+d),inviteLink.innerHTML="email invite link",c=-1;default:return{value:void 0,done:!0}}}var c=0,d,e,f,g={next:function(a){return b(0,a,void 0)},"throw":function(a){return b(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();g[Symbol.iterator]=function(){return this};return g}())};
Glue.prototype.initClient=function(a){var b=this;return $jscomp.executeAsyncGenerator(function(){function c(c,n,r){for(;;)switch(d){case 0:return table.innerHTML="Connecting to game server..",m=new GameClient(b.window),d=1,{value:m.init(a),done:!1};case 1:if(1!=c){d=2;break}d=-1;throw r;case 2:return d=3,{value:m.getChannel(),done:!1};case 3:if(1!=c){d=4;break}d=-1;throw r;case 4:return k=l=n,k.onclose=function(a){return b.window.location.reload()},table.innerHTML="",h=new MessageSenderX,g=new MessageListener,
h.setSender(function(a){return k.send(a)}),k.onmessage=function(a){return g.handle(a.data)},f=b,d=5,{value:(new Ruleta(b.window.document,b.window,new RuletaRemota(h,g))).initAll(table),done:!1};case 5:if(1!=c){d=6;break}d=-1;throw r;case 6:e=n,f.client=e,d=-1;default:return{value:void 0,done:!0}}}var d=0,e,f,g,h,k,l,m,n={next:function(a){return c(0,a,void 0)},"throw":function(a){return c(1,void 0,a)},"return":function(a){throw Error("Not yet implemented");}};$jscomp.initSymbolIterator();n[Symbol.iterator]=
function(){return this};return n}())};game_=(new Glue(window,document)).init();